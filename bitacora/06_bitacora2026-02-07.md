# Bitácora — Thickener Water Recovery Sentinel (TWS)

> Registro de cambios, decisiones de diseño y validaciones.  
> Fecha actual de trabajo: **2026-02-08**

---

## 2026-02-08 — Enfoque “2 capas” + realismo operacional (Ricardo) + EDA listo

### Decisiones de foco (para portafolio y producto)
- Se adoptó un diseño por **2 capas**:
  - **Capa A (Core, no negociable):**
    - Turbidez CLEAN + turbidez medida con fallas
    - Torque (kNm y %)
    - Bed level
    - UF density / UF flow
    - Floc dose
    - Dilution on/off
    - ControlMode manual/auto
    - Yield stress (truth / soft-sensor)
  - **Capa B (alto ROI):**
    - Se deja planificado agregar `Feed_P80_um` intermitente (hold ~4h) y/o Conductividad/pH con flags de confianza.

### Cambios al simulador (simulate_fixed.py)
- Se incorporó la hipótesis operacional clave del profesor Ricardo:
  - **El torque se relaciona con la reología (Yield Stress) y NO directamente con Cp (% sólidos).**
- Se agregaron variables:
  - `UF_YieldStress_Pa` (proxy truth de reología UF)
  - `RakeTorque_kNm` y `RakeTorque_pct` (derivado desde kNm)
  - `Clay_pct` y `Clay_idx` como **drivers latentes** (no se asumen medibles online)
- Se corrigieron inconsistencias/bugs detectados en versiones previas:
  - uso de YS antes de ser calculado
  - referencias a `torque` inexistente (reemplazado por `torque_pct`)
  - duplicación de columna `RakeTorque_pct` en DataFrame
- Se mantuvo el esquema de:
  - turbidez truth: `Overflow_Turb_NTU_clean`
  - turbidez medida: `Overflow_Turb_NTU` con fallas (spikes/stuck/drift/missing)
  - etiquetas `event_now` basadas en CLEAN sostenida sobre 100 NTU.

### Calibración / Validación (quick_checks)
Se iteró sobre `deadband` para balancear:
- tasa de eventos sostenidos >100 NTU (meta 3–6%)
- fracción manual (meta 15–30%)
- degradación 50–100 NTU (meta aproximada ~15%, aceptando variación)
- puntos sobre spec >200 NTU (mantener cola razonable)

**Configuración aceptada (al cierre del día):**
- `deadband = 0.315`
- Resultados:
  - **Eventos (CLEAN >100 sostenido): ~5.12%**
  - **Modo manual: ~29.62%**
  - **Degradación (50–100): ~18.61%**
  - **Sobre spec (CLEAN >200): ~1.46%**
  - `scale` calibrado automáticamente para mantener event_rate objetivo.

> Nota: degradación quedó algo sobre la “meta ~15%”, pero con cola y manual en rangos buenos. Se decide avanzar a EDA y revisar luego si es necesario ajustar finamente.

### EDA
- Se construyó y validó la **Figura 1 (Plotly)**:
  - Timeline con turbidez CLEAN vs medida
  - bandas verde/degradado/crítico
  - marcadores de `event_now`
  - sombreado por `ControlMode == MANUAL`
- Resultado: la diferencia CLEAN vs medida es visible, eventos se ven sostenidos y el sombreado manual es legible.

### Documentación actualizada (pendiente de commit)
Se redactaron (para copiar/pegar en repo):
- `README.md`
- `docs/PROJECT_OVERVIEW.md`
- `docs/ARCHITECTURE.md`
- `docs/DATA_DICTIONARY.md`
- `docs/CAMPAIGNS.md`
- `docs/ROADMAP.md`
- `docs/PLAYBOOK.md`
- `docs/MODELING.md`

---

## Próximos pasos (siguiente sesión)
1) Completar EDA (Figuras 2–5).
2) Baseline ML con split temporal:
   - features con lags/rolling
   - métricas operacionales (falsas alarmas/día, lead time)
3) Sensor-health mínimo:
   - detectar turbidez stuck/flatline/drift
   - score de confianza `conf_turbidity`
4) (Capa B) Elegir 1–2 variables:
   - `Feed_P80_um` intermitente (hold ~4h)
   - `Water_Conductivity_uS_cm` y/o `pH_meas` + confidence flag
